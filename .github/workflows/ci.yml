name: CI
#test
on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-web:
    name: Build (Emscripten)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: latest

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build zip python3

      - name: Configure (CMake + emcmake)
        run: |
          cmake --version
          emcc -v
          mkdir -p build
          cd build
          emcmake cmake .. -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo

      - name: Build (wasm)
        run: |
          cmake --build build --config RelWithDebInfo -j 2 --target \
            Luau.LuauCeption.Compiler \
            Luau.LuauCeption.VM \
            Luau.LuauCeption.Full

      - name: Install wasm2luau
        run: |
          bash utils/setup_wasm2luau.sh
          chmod +x utils/wasm2luau

      - name: Install Aftman (for lune/darklua)
        shell: bash
        run: |
          set -euo pipefail
          TAG="v0.3.0"
          AFTMAN_URL="https://github.com/LPGhatguy/aftman/releases/download/${TAG}/aftman-0.3.0-linux-x86_64.zip"

          curl -L "$AFTMAN_URL" -o aftman.zip
          rm -rf aftman-bin
          mkdir -p aftman-bin
          unzip -q aftman.zip -d aftman-bin
          chmod +x aftman-bin/aftman
          echo "$(pwd)/aftman-bin" >> "$GITHUB_PATH"

          # Tools get installed into ~/.aftman/bin
          ./aftman-bin/aftman --version
          ./aftman-bin/aftman install --no-trust-check
          echo "$HOME/.aftman/bin" >> "$GITHUB_PATH"

      - name: Build Luau outputs (onefile)
        run: |
          lune --version
          darklua --version
          lune run ./src/builder -f BUILD_ONEFILE

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luauception-build
          path: |
            build/Luau.LuauCeption.*.wasm
            build/Luau.LuauCeption.*.js
            output/**
          if-no-files-found: error

      - name: Upload Luau outputs (.luau)
        uses: actions/upload-artifact@v4
        with:
          name: luauception-luau
          path: |
            output/Luau.LuauCeption.*.luau
          if-no-files-found: error
